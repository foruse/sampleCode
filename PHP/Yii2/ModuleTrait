<?php

/**
 * @author GBKSOFT team <hello@gbksoft.com>
 * @link http://gbksoft.com
 * @copyright 2011-2015 GBKSOFT team
 * @since 1.0
 *
 */

namespace common\components;

use Yii;

/*
 * Trait for modules in the system
 */
trait ModuleTrait
{
    /**
     * @var \yii\swiftmailer\Mailer Mailer instance
     */
    private $_mail;

    /**
     * Initializes the module.
     *
     * This method is called after the module is created and initialized with property values
     * given in configuration. The default implementation will initialize [[controllerNamespace]]
     * if it is not set.
     *
     * If you override this method, please make sure you call the parent implementation.
     */
    public function init()
    {
        if ($this->controllerNamespace === null) {
            $class = get_class($this);
            if (($pos = strrpos($class, '\\')) !== false) {
                $this->controllerNamespace = substr($class, 0, $pos) . '\\controllers\\' . Yii::$app->id;
            }
        }

        //Set path to views for module application
        $this->setViewPath($this->basePath . DIRECTORY_SEPARATOR . 'views' . DIRECTORY_SEPARATOR . Yii::$app->id);

        parent::init();
    }

    /**
     * Return new instance of the model
     *
     * @param string $name Model name in this module
     * @return object|null
     */
    public function getModel($name)
    {
        $modelClass = '';
        $class = get_class($this);
        if (($pos = strrpos($class, '\\')) !== false) {
            $modelClass = substr($class, 0, $pos) . '\\models\\' . ucfirst($name);
        }
        return $modelClass ? new $modelClass : null;
    }

    /**
     * @return \yii\swiftmailer\Mailer Mailer instance with predefined templates.
     */
    public function getMail()
    {
        if ($this->_mail === null) {
            $this->_mail = Yii::$app->getMailer();
            $this->_mail->htmlLayout = $this->basePath . DIRECTORY_SEPARATOR . 'mails' . DIRECTORY_SEPARATOR . 'layouts' . DIRECTORY_SEPARATOR . 'html';
            $this->_mail->textLayout = $this->basePath . DIRECTORY_SEPARATOR . 'mails' . DIRECTORY_SEPARATOR . 'layouts' . DIRECTORY_SEPARATOR . 'text';
            $this->_mail->viewPath = $this->basePath . DIRECTORY_SEPARATOR . 'mails' . DIRECTORY_SEPARATOR . 'views';
        }

        return $this->_mail;
    }
}
